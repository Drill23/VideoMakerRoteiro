<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mock WhatsApp ‚Äî Lucas</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
--bg: #0b141a; --bg-chat: #111b21; --bg-header: #202c33; --bg-sent: #005c4b; --bg-received: #202c33; --txt: #e9edef; --txt-dim: #8696a0; --accent: #25d366;
--chat-bg-image: url('data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="240" height="240"><rect width="240" height="240" fill="%23111b21"/><g stroke="%2327343b" stroke-width="1.2" fill="none" opacity="0.6"><path d="M20 30c6-6 16-6 22 0M60 30c6-6 16-6 22 0M100 30c6-6 16-6 22 0M140 30c6-6 16-6 22 0M180 30c6-6 16-6 22 0"/><circle cx="40" cy="70" r="10"/><rect x="80" y="62" width="24" height="16" rx="3"/><path d="M140 62h24v16h-24z"/><path d="M180 62l12 8-12 8z"/></g></svg>');
}
* { box-sizing: border-box }
body { margin: 0; background: #0a0a0a; color: #fff; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
.wrap { display: flex; gap: 16px; padding: 16px; align-items: flex-start; }
.panel { width: 360px; background: #131a20; border: 1px solid #26313a; border-radius: 12px; padding: 14px; }
.panel h3 { margin: 20px 0 8px; font-size: 16px; border-top: 1px solid #26313a; padding-top: 16px;}
.panel h3:first-child { margin-top: 0; border-top: 0; padding-top: 0; }
.panel label { display: block; font-size: 12px; color: #b6c2c9; margin-top: 10px; margin-bottom: 4px }
.panel input[type="text"], .panel textarea, .panel select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #2b3942; background: #0f171c; color: #dfe7eb; font-family: inherit; font-size: 14px; }
.panel textarea { resize: vertical; }
.avatar-edit { display: flex; align-items: center; gap: 10px; padding: 8px; background: #0f171c; border: 1px dashed #2b3942; border-radius: 10px; cursor: pointer }
.avatar-edit img { width: 44px; height: 44px; object-fit: cover; border: 2px solid #1f2c34 }
#contactPreview, #mePreview { border-radius: 50% }
#bgPreview { border-radius: 6px; }
.sub { font-size: 12px; color: #8aa0aa }
.btn { width: 100%; margin-top: 12px; padding: 10px 12px; border: 0; border-radius: 8px; background: #0b84ff; color: #fff; font-weight: 700; cursor: pointer; font-size: 14px; transition: background-color .2s; }
.btn:disabled { background-color: #555; cursor: not-allowed; }
.btn.btn-record { background-color: #25d366; }
.btn.btn-record:disabled { background-color: #c42727; }
.btn-ghost { background: #22303a }
.btn-danger { background: #4a212b; color: #ff8295; }
.phone { width: 390px; height: 844px; border-radius: 32px; overflow: hidden; background: var(--bg); border: 1px solid #1a232a; box-shadow: 0 20px 60px rgba(0,0,0,.45); display: flex; flex-direction: column; }
.statusbar { height: 26px; padding: 4px 10px; display: flex; align-items: center; justify-content: space-between; color: #fff; font-weight: 600; flex-shrink: 0; }
.statusbar .l { font-variant-numeric: tabular-nums }
.statusbar .r { display: flex; gap: 8px; align-items: center; opacity: .9 }
.sig, .wifi, .bat { width: 16px; height: 10px; background: #fff; mask-repeat: no-repeat; mask-size: contain }
.sig { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="20"><g fill="%23fff"><rect x="0" y="10" width="3" height="10"/><rect x="5" y="8" width="3" height="12"/><rect x="10" y="6" width="3" height="14"/><rect x="15" y="4" width="3" height="16"/></g></svg>');}
.wifi { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M12 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm6.5-6.5a10 10 0 0 0-13 0l1.5 1.5a8 8 0 0 1 10 0l1.5-1.5Zm3-3a15 15 0 0 0-19 0l1.5 1.5a13 13 0 0 1 16 0l1.5-1.5Z"/></svg>');}
.bat { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 14"><rect x="1" y="3" width="20" height="8" rx="2" fill="white"/><rect x="22" y="5" width="3" height="4" rx="1" fill="white"/></svg>');}
.header { height: 64px; background: var(--bg-header); display: flex; align-items: center; gap: 10px; padding: 8px 12px; color: #fff; border-bottom: 1px solid #1a232a; position:relative; z-index: 10; flex-shrink: 0; }
.back { width: 24px; height: 24px; background: #fff; mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="m15 18-6-6 6-6"/></svg>'); mask-size: contain; mask-repeat: no-repeat; opacity: .9 }
.contact-pic { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
.name { font-weight: 700 }
.top-actions { margin-left: auto; display: flex; gap: 14px }
.icon { width: 22px; height: 22px; background: #fff; mask-size: contain; mask-repeat: no-repeat; opacity: .9 }
.video { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M15 8.5V7a2 2 0 0 0-2-2H5A2 2 0 0 0 3 7v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1.5l6 3v-13l-6 3Z"/></svg>');}
.phone-ico { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M6.6 10.8a15.1 15.1 0 0 0 6.6 6.6l2.2-2.2a1 1 0 0 1 1-.26c1.1.36 2.3.56 3.6.56a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1C10.6 21 3 13.4 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.3.2 2.5.56 3.6a1 1 0 0 1-.26 1L6.6 10.8Z"/></svg>');}
.chat { flex: 1; background-color: var(--bg-chat); position: relative; display: flex; flex-direction: column; justify-content: flex-start; overflow: hidden; }
.chat::before { content: ""; position: absolute; inset: 0; opacity: .18; background-image: var(--chat-bg-image); background-size: cover; background-position: center; }
.scroll { position: relative; padding: 12px; overflow: auto; height: 100%; }
.msg-row { display: flex; gap: 6px; margin: 6px 0; align-items: flex-end; animation: fadeIn .3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.msg-row.me { justify-content: flex-end }
.bubble { max-width: 78%; padding: 8px 10px; border-radius: 14px; font-size: 15px; line-height: 1.3; color: var(--txt); box-shadow: 0 1px 0 rgba(0,0,0,.25); }
.bubble.recv { background: var(--bg-received); border-bottom-left-radius: 4px }
.bubble.sent { background: var(--bg-sent); border-bottom-right-radius: 4px }
.meta { font-size: 11px; color: var(--txt-dim); display: flex; align-items: center; gap: 4px; justify-content: flex-end; margin-top: 6px }
.ticks { width: 16px; height: 12px; background: #53bdeb; mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 18"><path fill="%2353bdeb" d="M9 11 5 7l-2 2 6 6 9-9-2-2-7 7Zm10 0-4-4-2 2 6 6 9-9-2-2-7 7Z"/></svg>'); mask-size: contain; mask-repeat: no-repeat }
.avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.composer { height: 56px; background: var(--bg-header); display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-top: 1px solid #1a232a; position: relative; z-index: 10; flex-shrink: 0;}
.ico { width: 24px; height: 24px; background: #b7c2c8; mask-size: contain; mask-repeat: no-repeat; opacity: .9 }
.plus { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M11 5h2v14h-2z"/><path fill="white" d="M5 11h14v2H5z"/></svg>');}
.emoji { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="8.5" cy="9.5" r="1.5" fill="white"/><circle cx="15.5" cy="9.5" r="1.5" fill="white"/><path fill="none" stroke="white" stroke-width="2" d="M7 14c1.2 1.2 2.7 2 5 2s3.8-.8 5-2"/></svg>');}
.camera { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M9 4 7.5 6H5a3 3 0 0 0-3 3v8a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V9a3 3 0 0 0-3-3h-2.5L15 4H9Zm3 5a5 5 0 1 1 0 10 5 5 0 0 1 0-10Z"/></svg>');}
.mic { mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm-7-3a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0H5Z"/><path fill="white" d="M11 19h2v3h-2z"/></svg>');}
.input { flex: 1; background: #0f1a20; border: 1px solid #2b3942; color: #dfe7eb; border-radius: 20px; padding: 10px 12px; font-size: 14px }
.hidden { display: none }
</style>
</head>
<body>
<div class="wrap">
<div class="panel">
<h3>Configura√ß√µes Gerais</h3>
<label>Nome do contato</label>
<input id="contactName" type="text" value="M√£e" />
<label style="margin-top:12px;">Foto do contato</label>
<div class="avatar-edit" id="pickContact"><img id="contactPreview" alt="Pr√©via do avatar do contato"><div><div style="font-weight:700">Selecionar imagem</div><div class="sub">Clique para enviar</div></div><input id="fileContact" type="file" accept="image/*" class="hidden"></div>
<label style="margin-top:12px;">Seu nome</label>
<input id="meName" type="text" value="Ana" />
<label>Sua foto</label>
<div class="avatar-edit" id="pickMe"><img id="mePreview" alt="Pr√©via do seu avatar"><div><div style="font-weight:700">Selecionar imagem</div><div class="sub">Opcional</div></div><input id="fileMe" type="file" accept="image/*" class="hidden"></div>
<label style="margin-top:12px;">Plano de fundo</label>
<div class="avatar-edit" id="pickBg"><img id="bgPreview" alt="Pr√©via do plano de fundo"><div><div style="font-weight:700">Selecionar imagem</div><div class="sub">JPG/PNG para o fundo</div></div><input id="fileBg" type="file" accept="image/*" class="hidden"></div>
<button id="removeBg" class="btn btn-danger" style="display: none; font-size: 12px; padding: 8px;">Remover fundo</button>

<h3>Gerador de Conversa</h3>
<label>Adicionar mensagem (Manual)</label>
<div style="background:#0f171c; padding:10px; border-radius: 8px; border:1px solid #2b3942;">
<textarea id="manualMessageText" rows="3" placeholder="Digite a mensagem..."></textarea>
<select id="messageSender" style="margin-top:8px;"><option value="me">Eu</option><option value="contact">Contato</option></select>
<button id="addMessageBtn" class="btn">Adicionar Mensagem</button>
</div>
<label style="margin-top:12px;">Gerar a partir de roteiro</label>
<textarea id="scriptInput" rows="8" placeholder="Cole o roteiro aqui... Exemplo:&#10;Ana: Oi m√£e!&#10;M√£e: Oi filha, tudo bem?"></textarea>
<button id="generateScriptBtn" class="btn">Gerar Conversa</button>
<button id="clearChatBtn" class="btn btn-danger">Limpar Conversa</button>

<h3>Exportar</h3>
<button id="recordVideoBtn" class="btn btn-record">üé¨ Salvar V√≠deo</button>
</div>

<div class="phone" id="phone">
<div class="statusbar">
<div class="l" id="clock"></div>
<div class="r">
<div class="sig"></div><div class="wifi"></div><div class="bat" style="width:20px;"></div>
</div>
</div>
<div class="header">
<div class="back"></div>
<img class="contact-pic" id="headerPic" alt="Avatar do contato no cabe√ßalho">
<div><div class="name" id="headerName"></div></div>
<div class="top-actions"><div class="icon video"></div><div class="icon phone-ico"></div></div>
</div>
<div class="chat" id="chat">
<div class="scroll" id="scroll"></div>
</div>
<div class="composer">
<div class="ico plus"></div><div class="ico emoji"></div>
<input class="input" placeholder="Mensagem"/>
<div class="ico camera"></div><div class="ico mic"></div>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
// --- ELEMENTOS DO DOM ---
const contactNameInput = document.getElementById('contactName');
const meNameInput = document.getElementById('meName');
const pickContact = document.getElementById('pickContact'), fileContact = document.getElementById('fileContact');
const pickMe = document.getElementById('pickMe'), fileMe = document.getElementById('fileMe');
const contactPreview = document.getElementById('contactPreview'), mePreview = document.getElementById('mePreview');
const pickBg = document.getElementById('pickBg'), fileBg = document.getElementById('fileBg'), bgPreview = document.getElementById('bgPreview'), removeBg = document.getElementById('removeBg');
const manualMessageText = document.getElementById('manualMessageText'), messageSender = document.getElementById('messageSender'), addMessageBtn = document.getElementById('addMessageBtn');
const scriptInput = document.getElementById('scriptInput'), generateScriptBtn = document.getElementById('generateScriptBtn'), clearChatBtn = document.getElementById('clearChatBtn');
const recordVideoBtn = document.getElementById('recordVideoBtn');
const allButtons = document.querySelectorAll('.btn');
const phone = document.getElementById('phone');
const statusbar = phone.querySelector('.statusbar');
const header = phone.querySelector('.header');
const composer = phone.querySelector('.composer');
const chat = document.getElementById('chat');
const scroll = document.getElementById('scroll');
const headerName = document.getElementById('headerName');
const headerPic = document.getElementById('headerPic');

// --- ESTADO ---
let contactAvatarUrl = null, meAvatarUrl = null;
const defaultBgSVG = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%2327343b"/></svg>';

// --- FUN√á√ïES B√ÅSICAS ---
const getCurrentTime = () => new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
function createPlaceholder(letter) { return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%231f2c34'/><text x='50%' y='55%' fill='%238696a0' font-size='40' font-family='Inter, sans-serif' text-anchor='middle' dy='.1em'>${encodeURIComponent(letter)}</text></svg>`; }
function readImg(file, callback) { const reader = new FileReader(); reader.onload = e => callback(e.target.result); reader.readAsDataURL(file); }

function updateUI() {
const contactName = contactNameInput.value || 'Contato';
const meName = meNameInput.value || 'Eu';
headerName.textContent = contactName;
messageSender.options[0].textContent = `Eu (${meName})`;
messageSender.options[1].textContent = `Contato (${contactName})`;
const contactInitial = contactName.trim().charAt(0).toUpperCase();
const meInitial = meName.trim().charAt(0).toUpperCase();
const finalContactSrc = contactAvatarUrl || createPlaceholder(contactInitial);
const finalMeSrc = meAvatarUrl || createPlaceholder(meInitial);
contactPreview.src = finalContactSrc;
headerPic.src = finalContactSrc;
document.querySelectorAll('.contact-avatar').forEach(el => el.src = finalContactSrc);
mePreview.src = finalMeSrc;
}

// --- FUN√á√ïES DO GERADOR DE CONVERSA ---
function addMessage(sender, text, timestamp) {
const row = document.createElement('div');
row.className = 'msg-row';
const bubble = document.createElement('div');
bubble.className = 'bubble';
const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
bubble.innerHTML = `${sanitizedText}<div class="meta">${timestamp || getCurrentTime()}</div>`;
if (sender === 'me') {
row.classList.add('me');
bubble.classList.add('sent');
bubble.querySelector('.meta').innerHTML += `<span class="ticks"></span>`;
} else {
bubble.classList.add('recv');
const avatar = document.createElement('img');
avatar.className = 'avatar contact-avatar';
avatar.src = contactAvatarUrl || createPlaceholder((contactNameInput.value||'C').charAt(0));
row.appendChild(avatar);
}
row.appendChild(bubble);
scroll.appendChild(row);
scroll.scrollTop = scroll.scrollHeight;
}

function parseAndGenerateScript() {
clearChatBtn.click();
const script = scriptInput.value.trim();
if (!script) return;
const meName = meNameInput.value.trim().toLowerCase();
const contactName = contactNameInput.value.trim().toLowerCase();
const lines = script.split('\n');
let currentSender = null;
let messageBuffer = [];
const flushMessage = () => { if (currentSender && messageBuffer.length > 0) { addMessage(currentSender, messageBuffer.join('\n')); messageBuffer = []; } };
lines.forEach(line => {
const match = line.match(/^([^:]+):/);
if (match) {
flushMessage();
const speaker = match[1].trim().toLowerCase();
currentSender = (speaker === meName) ? 'me' : 'contact';
const messagePart = line.substring(match[0].length).trim();
if (messagePart) messageBuffer.push(messagePart);
} else {
if (currentSender) messageBuffer.push(line.trim());
}
});
flushMessage();
updateUI();
}

// =================================================================
// FUN√á√ÉO DE GRAVA√á√ÉO DE V√çDEO (VERS√ÉO FINAL E OTIMIZADA)
// =================================================================
async function recordVideo() {
    if (!('MediaRecorder' in window)) {
        alert('Este navegador n√£o suporta grava√ß√£o de v√≠deo. Tente em um navegador mais recente.');
        return;
    }

    if (scroll.scrollHeight <= scroll.clientHeight + 16) {
        alert("A conversa √© muito curta para gerar um v√≠deo com rolagem.");
        return;
    }

    recordVideoBtn.textContent = 'Preparando... üõ†Ô∏è';
    allButtons.forEach(b => b.disabled = true);
    scroll.scrollTop = 0;
    await new Promise(r => setTimeout(r, 120));

    const getSupportedMimeType = () => {
        const candidates = ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm'];
        return candidates.find(type => MediaRecorder.isTypeSupported(type)) || '';
    };

    let recorder = null;
    let animationFrameId = null;
    let stopPromise;
    let finalizeDownload = null;

    try {
        const scale = Math.max(2, window.devicePixelRatio || 1);
        const renderOptions = { scale, useCORS: true, logging: false, backgroundColor: null };

        const backgroundColor = getComputedStyle(chat).backgroundColor;

        const [statusbarCanvas, headerCanvas, composerCanvas, chatCanvas, scrollCanvas] = await Promise.all([
            html2canvas(statusbar, renderOptions),
            html2canvas(header, renderOptions),
            html2canvas(composer, renderOptions),
            html2canvas(chat, { ...renderOptions, backgroundColor }),
            html2canvas(scroll, renderOptions)
        ]);

        const mainCanvas = document.createElement('canvas');
        mainCanvas.width = phone.offsetWidth * scale;
        mainCanvas.height = phone.offsetHeight * scale;
        const ctx = mainCanvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        const stream = mainCanvas.captureStream(30);
        const mimeType = getSupportedMimeType();
        if (!mimeType) {
            throw new Error('Nenhum formato de v√≠deo suportado foi encontrado.');
        }

        recorder = new MediaRecorder(stream, {
            mimeType,
            videoBitsPerSecond: 6000000
        });

        const chunks = [];
        recorder.ondataavailable = e => {
            if (e.data && e.data.size) {
                chunks.push(e.data);
            }
        };

        stopPromise = new Promise((resolve, reject) => {
            recorder.onstop = resolve;
            recorder.onerror = event => reject(event.error || new Error('Falha na grava√ß√£o.'));
        });

        finalizeDownload = () => {
            if (!chunks.length) {
                throw new Error('Nenhum dado de v√≠deo foi gerado.');
            }
            const blob = new Blob(chunks, { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversa-${Date.now()}.webm`;
            a.click();
            URL.revokeObjectURL(url);
        };

        recorder.start();
        recordVideoBtn.textContent = 'Gravando... üî¥';

        const statusbarHeight = statusbarCanvas.height;
        const headerHeight = headerCanvas.height;
        const composerHeight = composerCanvas.height;
        const chatTop = statusbarHeight + headerHeight;
        const visibleHeight = scroll.clientHeight * scale;
        const maxOffset = Math.max(0, scrollCanvas.height - visibleHeight);
        const scrollSpeed = 2 * scale;
        const holdFrames = 45;
        let yOffset = 0;
        let framesAfterEnd = 0;
        let stopped = false;

        const renderFrame = () => {
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            ctx.drawImage(chatCanvas, 0, chatTop);
            const scrollY = chatTop - yOffset;
            ctx.drawImage(scrollCanvas, 0, scrollY);
            ctx.drawImage(statusbarCanvas, 0, 0);
            ctx.drawImage(headerCanvas, 0, statusbarHeight);
            ctx.drawImage(composerCanvas, 0, mainCanvas.height - composerHeight);
        };

        const step = () => {
            renderFrame();

            if (yOffset >= maxOffset) {
                framesAfterEnd += 1;
                if (!stopped && framesAfterEnd >= holdFrames) {
                    stopped = true;
                    recorder.stop();
                    return;
                }
            } else {
                yOffset = Math.min(maxOffset, yOffset + scrollSpeed);
            }

            animationFrameId = requestAnimationFrame(step);
        };

        animationFrameId = requestAnimationFrame(step);

        await stopPromise;

        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        renderFrame();
        if (typeof finalizeDownload === 'function') {
            finalizeDownload();
        }

    } catch (error) {
        console.error('Erro ao gravar o v√≠deo:', error);
        if (stopPromise) {
            try { await stopPromise; } catch (err) { console.warn('Grava√ß√£o finalizada com erro:', err); }
        }
        alert(error?.message ? `Ocorreu um erro: ${error.message}` : 'Ocorreu um erro ao tentar gravar o v√≠deo.');
    } finally {
        if (recorder && recorder.state === 'recording') {
            try { recorder.stop(); } catch (err) { console.warn('N√£o foi poss√≠vel finalizar o gravador:', err); }
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        recordVideoBtn.textContent = 'üé¨ Salvar V√≠deo';
        allButtons.forEach(b => b.disabled = false);
    }
}

// --- EVENT LISTENERS ---
contactNameInput.addEventListener('input', updateUI);
meNameInput.addEventListener('input', updateUI);
pickContact.addEventListener('click', () => fileContact.click());
pickMe.addEventListener('click', () => fileMe.click());
fileContact.addEventListener('change', e => e.target.files[0] && readImg(e.target.files[0], url => { contactAvatarUrl = url; updateUI(); }));
fileMe.addEventListener('change', e => e.target.files[0] && readImg(e.target.files[0], url => { meAvatarUrl = url; updateUI(); }));
pickBg.addEventListener('click', () => fileBg.click());
fileBg.addEventListener('change', e => e.target.files[0] && readImg(e.target.files[0], url => {bgPreview.src = url;chat.style.setProperty('--chat-bg-image', `url(${url})`);removeBg.style.display = 'block';}));
removeBg.addEventListener('click', () => {chat.style.removeProperty('--chat-bg-image');bgPreview.src = defaultBgSVG;removeBg.style.display = 'none';fileBg.value = '';});
addMessageBtn.addEventListener('click', () => {const text = manualMessageText.value.trim();if (!text) return;addMessage(messageSender.value, text);manualMessageText.value = '';});
generateScriptBtn.addEventListener('click', parseAndGenerateScript);
clearChatBtn.addEventListener('click', () => scroll.innerHTML = '');
recordVideoBtn.addEventListener('click', recordVideo);

// --- INICIALIZA√á√ÉO ---
document.getElementById('clock').textContent = getCurrentTime();
bgPreview.src = defaultBgSVG;
updateUI();
scriptInput.value = "M√ÉE:\nPor favor, volta pra casa. S√≥ at√© a gente se ajeitar. Eu prometo que tudo vai mudar.\nANA:\nM√£e‚Ä¶ eu n√£o posso.\nM√ÉE:\nPor qu√™?\nANA:\nPorque eu t√¥ em Paris agora.";
});
</script>
</body>
</html>